#!/bin/bash
#
# Copyright 2024, UNSW
#
# SPDX-License-Identifier: BSD-2-Clause
#

if [ -z "${MICROKIT_SDK}" ]; then
    echo "MICROKIT_SDK must be specified"
    exit 1
fi

if [ -z "${MICROKIT_BOARD}" ]; then
    echo "MICROKIT_BOARD must be specified"
    exit 1
fi

MICROKIT_CONFIG="${MICROKIT_CONFIG:-debug}"
MICROKIT_SDK="${MICROKIT_SDK}"
MICROKIT_BOARD="${MICROKIT_BOARD}"

if [ -z "${BUILD_DIR}" ]; then
    BUILD_DIR=build
    # BUILD_DIR=${MICROKIT_BOARD}.${MICROKIT_CONFIG}
fi

case ${MICROKIT_BOARD} in
    odroidc4)
        UART_DRIVER=meson
        ETH_DRIV_DIR=meson
        TIMER_DRV_DIR=meson
        CPU=cortex-a55
        ;;
    imx8mm_evk)
        UART_DRIVER=imx
        ETH_DRIV_DIR=imx
        TIMER_DRV_DIR=imx
        CPU=cortex-a53
        ;;
    maaxboard)
        UART_DRIVER=imx
        ETH_DRIV_DIR=imx
        TIMER_DRV_DIR=imx
        CPU=cortex-a53
        ;;
    qemu_arm_virt)
        UART_DRIVER=arm
        ETH_DRIV_DIR=virtio
        TIMER_DRV_DIR=arm
        CPU=cortex-a53
        QEMU=qemu-system-aarch64
        ;;
    *)
        echo "Unsupported MICROKIT_BOARD given"
        exit 1
        ;;
esac

mkdir -p ${BUILD_DIR}
cp virtio_net.mk ${BUILD_DIR}/Makefile

BUILD_DIR=$(readlink -f "$BUILD_DIR")
MICROKIT_SDK=$(readlink -f "$MICROKIT_SDK")
VIRTIO_EXAMPLE=$(readlink -f .)

TARGET=${TARGET:-aarch64-none-elf}
CC=${CC:-clang}
LD=${LD:-ld.ldd}
AS=${AS:-llvm-as}
AR=${AR:-llvm-ar}
DTC=${DTC:-dtc}

MICROKIT_TOOL="${MICROKIT_SDK}/bin/microkit"
SDDF=$(readlink -f ../../dep/sddf)
VMM=$(readlink -f ../../)

CONFIG_FILE=${BUILD_DIR}/config.mk

echo "BUILD_DIR=${BUILD_DIR}" > ${CONFIG_FILE}
echo "MICROKIT_SDK=${MICROKIT_SDK}" >> ${CONFIG_FILE}
echo "MICROKIT_BOARD=${MICROKIT_BOARD}" >> ${CONFIG_FILE}
echo "MICROKIT_CONFIG=${MICROKIT_CONFIG}" >> ${CONFIG_FILE}
echo "TARGET=${TARGET}" >> ${CONFIG_FILE}
echo "CC=${CC}" >> ${CONFIG_FILE}
echo "LD=${LD}" >> ${CONFIG_FILE}
echo "AS=${AS}" >> ${CONFIG_FILE}
echo "AR=${AR}" >> ${CONFIG_FILE}
echo "DTC=${DTC}" >> ${CONFIG_FILE}
echo "MICROKIT_TOOL=${MICROKIT_TOOL}" >> ${CONFIG_FILE}
echo "SDDF=${SDDF}" >> ${CONFIG_FILE}
echo "VMM=${VMM}" >> ${CONFIG_FILE}
echo "VIRTIO_EXAMPLE=${VIRTIO_EXAMPLE}" >> ${CONFIG_FILE}
echo "UART_DRIVER=${UART_DRIVER}" >> ${CONFIG_FILE}
echo "ETH_DRIV_DIR=${ETH_DRIV_DIR}" >> ${CONFIG_FILE}
echo "TIMER_DRV_DIR=${TIMER_DRV_DIR}" >> ${CONFIG_FILE}
echo "CPU=${CPU}" >> ${CONFIG_FILE}
echo "QEMU=${QEMU}" >> ${CONFIG_FILE}
